# File dedicated to test real ACL use cases. This allow to test documentation
# exemple.

postgres:
  # Disable role management.
  roles_query: null


acls:
  # Provide a custom ACL
  public:
    type: datacl
    inspect: |
      -- Returns public if no ACLs are defined in this database.
      WITH
      acls AS (
          SELECT
              (aclexplode(datacl)).grantee AS grantee,
              (aclexplode(datacl)).privilege_type AS priv
          FROM pg_catalog.pg_database
          WHERE datname = current_database()
      ),
      static AS (
          SELECT NULL AS namespace, 'public' AS rolname
      )
      SELECT static.*, TRUE as "full" FROM static
      LEFT OUTER JOIN acls ON acls.grantee = 0
      WHERE acls.grantee IS NULL;
    revoke: |
      REVOKE CONNECT ON DATABASE {database} FROM {role}

  # Use **some** well-known ACLs. Other must be ignored.
  ro:
  - __connect__
  - __select_on_tables__
  - __select_on_sequences__
  - __usage_on_schemas__
  - __usage_on_types__

sync_map:
- grant:
    # Grant ro to some developers
    database: appdb
    schema: [appns]
    acl: ro
    roles:
    - daniel  # in fixture/postgres.sh: has partial grant
    - david   # in f/p.sh: already has full grant
    - denis   # has no grant
